<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      No, pest is not faster than nom &middot; Unhandled Expression
    
  </title>

  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-117988815-1', 'auto');
  ga('send', 'pageview');
  </script>



  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <img src="https://s.gravatar.com/avatar/ed9901b9b80743c05aedf58b4f4926dd?s=200" alt="self" />
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Unhandled Expression
      </a>
    </div>
    <p class="lead">Geoffroy Couprie – software security and architecture consultant</p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  
    
  

  
    
      <a class="page-link "
          href="/about.html">About</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  
    
  

  
    
  

  
    
      <a class="category-link "
          href="/category/architecture.html">Architecture</a>
    
  

  
    
      <a class="category-link "
          href="/category/crypto.html">Crypto</a>
    
  

  
    
      <a class="category-link "
          href="/category/development.html">Development</a>
    
  

  
    
  

  

  
    
      <a class="category-link "
          href="/category/rust.html">Rust</a>
    
  

  
    
  

  
    
      <a class="category-link "
          href="/category/security.html">Security</a>
    
  

  
    
  

  
    
      <a class="category-link "
          href="/category/videolan.html">VideoLAN</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  <nav id="sidebar-icon-links">
  

  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>
  <a class="category-link active" href="https://www.patreon.com/geoffroy">Support my work on Patreon</a>
  <!--<p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>
-->
</div>


    <main class="container">
      <header>
  <h1 class="post-title">No, pest is not faster than nom</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">04 Oct 2018</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        General
      
    
  </span>
</div>

  <div class="post-body">
    <p>As the main developer of <a href="https://github.com/geal/nom">nom, the Rust parser combinators
library</a>, I’m usually happy to
see other parser libraries appear in Rust. The language’s
strengths play well in that space, and writing parsers is
a nice way to explore it.</p>

<p>I’m also happy to see them <a href="https://github.com/geal/parser_benchmarks">compete in benchmarks with nom</a>, since it keeps me on my toes, and improves performance
for everybody. <a href="https://github.com/marwes/combine">Combine</a> has been
an interesting competitor here, showing how far one can go without using
macros.</p>

<p>That said, <a href="https://pest.rs/">the recent release of pest 2.0</a>,
a parsing expression grammar library, is pushing me to be petty :D</p>

<p>That library has been using a benchmark against nom <a href="https://github.com/sozu-proxy/sozu/blob/master/doc/getting_started.md#run-it-with-docker">in its
readme</a> for a long time. I wrote <a href="https://github.com/Geal/pestvsnom">that benchmark</a>
to help in the comparison, but the results were slightly misleading:</p>

<p><img src="/assets/pestvsnom_old.svg" alt="old benchmarks" /></p>

<p>The nom benchmark and the “pest (custom AST)” benchmark were
converting the JSON file to Rust types (<code class="highlighter-rouge">Vec</code>, <code class="highlighter-rouge">HashMap</code> for
objects, booleans, strings and floating point numbers).
While the simple pest parser was validating the file and
generating a list of tokens without converting them.
So, yes, of course it will be faster than nom.</p>

<p>There was <a href="https://github.com/Geal/parser_benchmarks/blob/588c2cddf9a625a7af6d34c1b4edd42536023121/json/README.md">further work on the benchmarks</a>,
while nom 4 was still in preparation, and pest got interesting
results:</p>

<p>The benchmarks were run on a late 2013 Macbook Pro, quad core 2,3 GHz Intel Core i7.</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>basic</th>
      <th>canada.json</th>
      <th>apache_builds.json</th>
      <th>data.json</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>combine</td>
      <td>(fails)</td>
      <td>127,775,522 ns/iter (+/- 11,140,676) = 17 MB/s</td>
      <td>3,732,534 ns/iter (+/- 795,836) = 34 MB/s</td>
      <td>241,407 ns/iter (+/- 40,575) = 38 MB/s</td>
    </tr>
    <tr>
      <td>nom</td>
      <td><strong>1,333 ns/iter (+/- 247) = 57 MB/s</strong></td>
      <td>62,971,567 ns/iter (+/- 6,311,768) = 35 MB/s</td>
      <td><strong>1,209,550 ns/iter (+/- 323,936) = 105 MB/s</strong></td>
      <td><strong>62,008 ns/iter (+/- 11,685) = 149 MB/s</strong></td>
    </tr>
    <tr>
      <td>pest</td>
      <td>1,405 ns/iter (+/- 238) = 54 MB/s</td>
      <td><strong>27,701,820 ns/iter (+/- 3,961,221) = 81 MB/s</strong></td>
      <td>1,694,463 ns/iter (+/- 338,194) = 75 MB/s</td>
      <td>131,851 ns/iter (+/- 22,667) = 70 MB/s</td>
    </tr>
  </tbody>
</table>

<p>I could have left it at that.</p>

<p>But today (October 4th, 2018), <a href="https://pest.rs/">the pest website</a>
featured a very misleading graph.</p>

<p><img src="/assets/pest-graph.png" alt="the pest benchmark graph" /></p>

<p>Yes, it’s very easy to make nom look bad if you:</p>

<ul>
  <li>conveniently remove the slowest pest parser</li>
  <li>do not put any link to the benchmark code</li>
  <li>avoid saying how many iterations are done, on which file, etc</li>
  <li><strong>start the horizontal axis at 20ms instead of 0ms, so that nom appears twice slower</strong></li>
</ul>

<p>this is ridiculous, and deserves all the pettiness I can muster.</p>

<h2 id="the-real-benchmark">The real benchmark</h2>

<p>I took the <a href="https://github.com/Geal/pestvsnom">old benchmark</a>
reused the <a href="https://github.com/Geal/pestvsnom/blob/master/assets/canada.json">canada.json file</a>,
added the <a href="https://github.com/Geal/pestvsnom/blob/master/assets/data.json">data.json file</a>
from <a href="https://github.com/pest-parser/pest/blob/master/grammars/benches/data.json">pest’s own JSON benchmark</a>, applied <a href="https://github.com/pest-parser/pest/blob/master/grammars/benches/json.rs">pest’s current way to bench its code</a> in <a href="https://github.com/Geal/pestvsnom/blob/master/benches/pest.rs">my benchmarks</a>.</p>

<p>After upgrading to nom 4 and pest 2, and fixing some old bugs in <a href="https://github.com/Geal/pestvsnom/blob/master/benches/nom.rs">the nom
parser</a>,
I could reproduce the old results (still on a late 2013 Macbook Pro,
quad core 2,3 GHz Intel Core i7, yes my laptop is getting old):</p>

<ul>
  <li>nom:
    <ul>
      <li><code class="highlighter-rouge">canada.json</code>: 60,734,229 ns/iter (+/- 17,775,618)</li>
      <li><code class="highlighter-rouge">data.json</code>: 23,937 ns/iter (+/- 9,992)</li>
    </ul>
  </li>
  <li>pest:
    <ul>
      <li><code class="highlighter-rouge">canada.json</code>: 35,041,472 ns/iter (+/- 5,454,302)</li>
      <li><code class="highlighter-rouge">data.json</code>: 14,665 ns/iter (+/- 2,041)</li>
    </ul>
  </li>
</ul>

<p>Yes, a pest 2.0 parser that does not convert the input to Rust types
is indeed faster than a nom 4.0 parser that does convert the input to
Rust types.</p>

<p>But what happens if I write <a href="https://github.com/Geal/pestvsnom/blob/master/benches/nom_spans.rs">a nom 4.0 parser that does not convert
its input to Rust types</a>?
It’s actually a bit easier if I don’t try to generates floats, bools, etc.
It’s not exactly what pest does. Pest stores indexes along with the original
slice, while this one will return sub slices for each JSON element.
Still, here are the results:</p>

<ul>
  <li>nom:
    <ul>
      <li><code class="highlighter-rouge">canada.json</code>: 60,734,229 ns/iter (+/- 17,775,618)</li>
      <li><code class="highlighter-rouge">data.json</code>: 23,937 ns/iter (+/- 9,992)</li>
    </ul>
  </li>
  <li>pest:
    <ul>
      <li><code class="highlighter-rouge">canada.json</code>: 35,041,472 ns/iter (+/- 5,454,302)</li>
      <li><code class="highlighter-rouge">data.json</code>: 14,665 ns/iter (+/- 2,041)</li>
    </ul>
  </li>
  <li>nom_spans (returning slices instead of converting to Rust types):
    <ul>
      <li><code class="highlighter-rouge">canada.json</code>: 20,623,381 ns/iter (+/- 1,952,297)</li>
      <li><code class="highlighter-rouge">data.json</code>: 10,757 ns/iter (+/- 1,462)</li>
    </ul>
  </li>
</ul>

<p>Or, represented as graphs that do not actually mislead us with their axis:</p>

<p><img src="/assets/canada-json-benchmark.png" alt="canada.json benchmark" /></p>

<p><img src="/assets/data-json-benchmark.png" alt="data.json benchmark" /></p>

<p>So, here we are, nom is actually still a lot faster than pest.
I still find pest’s parser interesting, because the grammar is
quite readable, but I tend to prefer parser combinators,
because they make it easy to <a href="https://github.com/pest-parser/pest/issues/197">reuse parsers and combinators</a>
and allow you to write your own custom elements as you wish.</p>

<p>So, here we are, if you see ways to improve the benchmarks,
and in the process make nom or pest faster, please do it :)</p>

<p><img src="/assets/comeatme.gif" alt="" /></p>

    



<div class="post-tags">
  
    
    <a href="/tags.html#rust">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Rust</span>
    </a>
  
    
    <a href="/tags.html#parser">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">parser</span>
    </a>
  
    
    <a href="/tags.html#security">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">security</span>
    </a>
  
    
    <a href="/tags.html#nom">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">nom</span>
    </a>
  
</div>
  </div>

  
<!--  <section class="comments">
    <h2>Comments</h2>
  </section>
-->


  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/general/2018/05/14/nom-4-0-faster-safer-simpler-parsers.html">
            nom 4.0: faster, safer, simpler parsers
            <small>14 May 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/general/rust/2018/02/02/poc-compiling-to-ebpf-from-rust.html">
            PoC: compiling to eBPF from Rust
            <small>02 Feb 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/rust/2018/01/10/rust-2018-maybe-dont-be-too-stable.html">
            Rust 2018: maybe don't be too stable
            <small>10 Jan 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
