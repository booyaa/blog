<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Fixing the DLL loading vulnerability &middot; Unhandled Expression
    
  </title>

  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-117988815-1', 'auto');
  ga('send', 'pageview');
  </script>



  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <img src="https://s.gravatar.com/avatar/ed9901b9b80743c05aedf58b4f4926dd?s=200" alt="self" />
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Unhandled Expression
      </a>
    </div>
    <p class="lead">Geoffroy Couprie – software security and architecture consultant</p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  
    
  

  
    
      <a class="page-link "
          href="/about.html">About</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  
    
  

  
    
  

  
    
      <a class="category-link "
          href="/category/architecture.html">Architecture</a>
    
  

  
    
      <a class="category-link "
          href="/category/crypto.html">Crypto</a>
    
  

  
    
      <a class="category-link "
          href="/category/development.html">Development</a>
    
  

  
    
  

  

  
    
      <a class="category-link "
          href="/category/rust.html">Rust</a>
    
  

  
    
  

  
    
      <a class="category-link "
          href="/category/security.html">Security</a>
    
  

  
    
  

  
    
      <a class="category-link "
          href="/category/videolan.html">VideoLAN</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  <nav id="sidebar-icon-links">
  

  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>
  <a class="category-link active" href="https://www.patreon.com/geoffroy">Support my work on Patreon</a>
  <!--<p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>
-->
</div>


    <main class="container">
      <header>
  <h1 class="post-title">Fixing the DLL loading vulnerability</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">23 Aug 2010</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        General
      
    
      &bull;

      
      
      

      
        <a href="/category/security.html">
          Security
        </a>
      
    
      &bull;

      
      
      

      
        <a href="/category/videolan.html">
          VideoLAN
        </a>
      
    
  </span>
</div>

  <div class="post-body">
    <p><strong>Update 24/08/2010: Microsoft published an <a href="https://www.microsoft.com/technet/security/advisory/2269637.mspx">advisory</a>, there's an <a href="http://blogs.technet.com/b/srd/archive/2010/08/23/more-information-about-dll-preloading-remote-attack-vector.aspx">article from the MSRC</a> about the preloading DLL vulnerability, and <a href="http://support.microsoft.com/kb/2264107">a tool</a> that fixes the problem. And if you want to know more, there's an <a href="http://msdn.microsoft.com/en-us/library/ff919712(VS.85).aspx">MSDN article</a>.</strong></p>
<p><strong>Update 25/08/2010: if you came here from golem.de, heise.de or h-online.com, good for you! The articles on these websites are blatantly wrong, and their proposed solution doesn't work . You will find here the real solutions, and links to the relevant blog posts and advisories.</strong></p>
<p>Look! <a href="http://www.securityfocus.com/archive/1/513190">A new</a> <a href="http://www.cs.ucdavis.edu/research/tech-reports/2010/CSE-2010-2.pdf">shiny</a> <a href="http://blog.metasploit.com/2010/08/exploiting-dll-hijacking-flaws.html">vulnerability</a>, affecting a lot of Windows applications! OMG OMG OMG we're DOOMED!</p>
<p>&lt;/crazy mode off&gt;</p>
<p>OK, let's get serious. This vulnerability is actually <a href="http://www.securityfocus.com/bid/1699/discuss">a very old one</a>. It is there because the <a href="http://msdn.microsoft.com/en-us/library/ms682586(v=VS.85).aspx">DLL search order</a> includes the current directory (if someone can tell me why, I would be delighted to know that). Here is the search order (source: <a href="http://msdn.microsoft.com/en-us/library/ms682586(v=VS.85).aspx">MSDN</a>):</p>
<blockquote><p>If <strong>SafeDllSearchMode</strong> is enabled, the search order is as follows:</p>
<ol>
<li>The directory from which the application loaded.</li>
<li>The system directory. Use the <a href="http://msdn.microsoft.com/en-us/library/ms724373(v=VS.85).aspx"><strong>GetSystemDirectory</strong></a> function to get the path of this directory.</li>
<li>The 16-bit system directory. There is no function that obtains the path of this directory, but it is searched.</li>
<li>The Windows directory. Use the <a href="http://msdn.microsoft.com/en-us/library/ms724454(v=VS.85).aspx"><strong>GetWindowsDirectory</strong></a> function to get the path of this directory.</li>
<li>The current directory.</li>
<li>The directories that are listed in the PATH environment variable. Note that this does not include the per-application path specified by the <strong>App Paths</strong> registry key. The <strong>App Paths</strong> key is not used when computing the DLL search path.</li>
</ol>
<p>If <strong>SafeDllSearchMode</strong> is disabled, the search order is as follows:</p>
<ol>
<li>The directory from which the application loaded.</li>
<li>The current directory.</li>
<li>The system directory. Use the <a href="http://msdn.microsoft.com/en-us/library/ms724373(v=VS.85).aspx"><strong>GetSystemDirectory</strong></a> function to get the path of this directory.</li>
<li>The 16-bit system directory. There is no function that obtains the path of this directory, but it is searched.</li>
<li>The Windows directory. Use the <a href="http://msdn.microsoft.com/en-us/library/ms724454(v=VS.85).aspx"><strong>GetWindowsDirectory</strong></a> function to get the path of this directory.</li>
</ol>
</blockquote>
<p>For the record: disabling SafeDllSearchMode means that you're stupid, or that you're using a Windows before XP SP1 (note that this is not exclusive).</p>
<p>So, let's assume that your application tries to load a DLL that isn't present, either in your application directory, or in the system directories. Then, the application will try to load the DLL from the current directory. And that's it. If there's a DLL with the same name in that folder, it will be loaded in the application. That's why you can get owned by opening a file in that same directory: it sets the current directory of the application to the file's folder.</p>
<p>OMG OMG OMG we're DOOMED, and it's incredibly easy to exploit me!</p>
<p>So, now, let's take a look at the fix. This is an OS flaw. You can't fix all your applications yourself. H.D. Moore has some <a href="http://blog.rapid7.com/?p=5325">sysadmin fixes</a> that you can apply to prevent the exploit from coming on your computer. But your applications will still be exploitable.</p>
<p>If you're a developer, though, you can fix your application. There's a function that can remove the current directory from the DLL search path: SetDllDirectory. From <a href="http://msdn.microsoft.com/en-us/library/ms686203(VS.85).aspx">MSDN</a>:</p>
<blockquote><p>After calling <strong>SetDllDirectory</strong>, the DLL search path is:</p>
<ol>
<li>The directory from which the application loaded.</li>
<li>The directory specified by the <em>lpPathName</em> parameter.</li>
<li>The system directory. Use the <a href="http://msdn.microsoft.com/en-us/library/ms724373(v=VS.85).aspx"><strong>GetSystemDirectory</strong></a> function to get the path of this directory. The name of this directory is System32.</li>
<li>The 16-bit system directory. There is no function that obtains the path of this directory, but it is searched. The name of this directory is System.</li>
<li>The Windows directory. Use the <a href="http://msdn.microsoft.com/en-us/library/ms724454(v=VS.85).aspx"><strong>GetWindowsDirectory</strong></a> function to get the path of this directory.</li>
<li>The directories that are listed in the PATH environment variable.</li>
</ol>
</blockquote>
<p>So, if you pass a safe directory(let's say, C:\Windows\System32, or your application directory) as argument to SetDllDirectory, you effectively remove the current directory from the search path! It works, I tested it for you :)</p>
<p>But that's not the end: you have to wipe out the PATH to be safe. <a href="http://blog.metasploit.com/2010/08/exploiting-dll-hijacking-flaws.html">From the metasploit blog</a>:</p>
<blockquote><p>If the application is trying to load a DLL that is normally found within the PATH, but not the Windows system directories, and the PATH contains environment variables that have not been set, then the literal value of the environment variable will be treated as sub-directory of the working directory (the share). For example, if %unknownvariable%\bin is in the system PATH, the share will be searched for a directory called “%unknownvariable%\bin” and the target DLL will be loaded from within this sub-directory.</p></blockquote>
<p>And if you test  your application with ProcMon, you will surely see that a lot of (potentially unsafe) directories are added to the PATH, and used to look for the DLL. So, remove all the useless directories from the PATH if you can!</p>
<p>(And now, for the disclaimer: this blog post is not endorsed by Microsoft, and if you want to be really safe and know the best solution to employ, wait for Microsoft's patches and workarounds. But if you trust me enough (you fool... *evil laugh*), you can try that fix on your application, and maybe protect your users. )</p>
<p>Actually, that fix is encouraged by Microsoft, and David Leblanc wrote about it in February 2008.</p>

    



<div class="post-tags">
  
    
    <a href="/tags.html#binary-planting">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">binary planting</span>
    </a>
  
    
    <a href="/tags.html#dll-hijacking">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">DLL hijacking</span>
    </a>
  
    
    <a href="/tags.html#dll-preloading">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">DLL preloading</span>
    </a>
  
    
    <a href="/tags.html#security">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">security</span>
    </a>
  
    
    <a href="/tags.html#vulnerabilities">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">vulnerabilities</span>
    </a>
  
    
    <a href="/tags.html#windows">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">windows</span>
    </a>
  
</div>
  </div>

  
<!--  <section class="comments">
    <h2>Comments</h2>
  </section>
-->


  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/general/2018/05/14/nom-4-0-faster-safer-simpler-parsers.html">
            nom 4.0: faster, safer, simpler parsers
            <small>14 May 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/general/rust/2018/02/02/poc-compiling-to-ebpf-from-rust.html">
            PoC: compiling to eBPF from Rust
            <small>02 Feb 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/rust/2018/01/10/rust-2018-maybe-dont-be-too-stable.html">
            Rust 2018: maybe don't be too stable
            <small>10 Jan 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
