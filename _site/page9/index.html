<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Unhandled Expression &middot; Geoffroy Couprie – software security and architecture consultant
    
  </title>

  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-117988815-1', 'auto');
  ga('send', 'pageview');
  </script>



  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="index">

    <div id="sidebar">
  <header>
    <img src="https://s.gravatar.com/avatar/ed9901b9b80743c05aedf58b4f4926dd?s=200" alt="self" />
    <h1 class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Unhandled Expression
      </a>
    </h1>
    <p class="lead">Geoffroy Couprie – software security and architecture consultant</p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  
    
  

  
    
      <a class="page-link "
          href="/about.html">About</a>
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  
    
  

  
    
  

  
    
      <a class="category-link "
          href="/category/architecture.html">Architecture</a>
    
  

  
    
      <a class="category-link "
          href="/category/crypto.html">Crypto</a>
    
  

  
    
      <a class="category-link "
          href="/category/development.html">Development</a>
    
  

  
    
  

  

  
    
      <a class="category-link "
          href="/category/rust.html">Rust</a>
    
  

  
    
  

  
    
      <a class="category-link "
          href="/category/security.html">Security</a>
    
  

  
    
  

  
    
      <a class="category-link "
          href="/category/videolan.html">VideoLAN</a>
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  <nav id="sidebar-icon-links">
  

  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>
  <a class="category-link active" href="https://www.patreon.com/geoffroy">Support my work on Patreon</a>
  <!--<p>
  &copy; 2018.
  <a href="/LICENSE.md">MIT License.</a>
</p>
-->
</div>


    <main class="container">
      <div class="content">
  
<div class="pagination">
  <a class="pagination-item newer"
     href="/page8">
    Newer
  </a>
</div>



  

  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/reinventing%20the%20wheel/ruby/smalltalk/2011/08/31/jtalk-on-rails-editing-javascript-in-my-browser.html">
        Jtalk on Rails: editing Javascript in my browser
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">31 Aug 2011</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        Reinventing the wheel
      
    
      &bull;

      
      
      

      
        Ruby
      
    
      &bull;

      
      
      

      
        Smalltalk
      
    
  </span>
</div>

    
      <p>If you don't know JTalk yet, you're missing something. It's an awesome piece of work: a Smalltalk to Javascript compiler and a Smalltalk editor running in Javascript, <strong>IN YOUR BROWSER</strong>! <a title="JTalk project page" href="http://jtalk-project.org/" target="_blank">Go check it out, now!</a></p>
<p>Now that you've played a bit with JTalk, let's get started.</p>
<p>If you're like me, you're a bit annoyed by WebDAV, the proposed solution to save changes to disk. And if you're like me, you would like to use Jtalk with Rails, and because you're a lazy ass like me, you use WEBrick instead of Apache for your development.</p>
<p>Let's hack something up to replace WebDAV!</p>
<h2>Create a Rails application</h2>
<p>[sourcecode language="bash"]<br />
rails new jtalkonrails<br />
cd jtalkonrails<br />
bundle install<br />
rm public/index.html<br />
rails generate controller home index<br />
printf &quot;Jtalkonrails::Application.routes.draw do\n  root :to =&gt; \&quot;home#index\&quot;\nend\n&quot; &gt; config/routes.rb<br />
[/sourcecode]</p>
<p>(I should really make a script out of all my rails initialization commands, one of these days...)</p>
<h2>Add Jtalk to your application</h2>
<p>[sourcecode language="bash"]<br />
cd public/<br />
wget http://github.com/NicolasPetton/jtalk/tarball/master --no-check-certificate<br />
tar zxvf master<br />
cp -R NicolasPetton-jtalk-20cd63e/st .<br />
cp -R NicolasPetton-jtalk-20cd63e/js .<br />
cp -R NicolasPetton-jtalk-20cd63e/css .<br />
cp -R NicolasPetton-jtalk-20cd63e/ide .<br />
rm -rf NicolasPetton-jtalk-20cd63e<br />
[/sourcecode]</p>
<p>JTalk stores source code in three forms: Smalltalk code, Javascript code and smaller Javascript code ("*.deploy.js").</p>
<h2>Jtalk hello world: the Counter example</h2>
<p>now, edit app/views/layouts/application.html.erb so that it looks like this:</p>
<p>[sourcecode language="html"]<br />
&lt;!DOCTYPE html&gt;<br />
&lt;html&gt;<br />
&lt;head&gt;<br />
  &lt;title&gt;Jtalk On Rails&lt;/title&gt;<br />
  &lt;%= stylesheet_link_tag :all %&gt;<br />
  &lt;%= javascript_include_tag :defaults %&gt;<br />
  &lt;%= csrf_meta_tag %&gt;<br />
  &lt;script src=&quot;js/jtalk.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;<br />
  &lt;script type=&quot;text/javascript&quot;&gt; loadJtalk()&lt;/script&gt;<br />
&lt;/head&gt;<br />
&lt;body&gt;<br />
&lt;button onclick=&quot;smalltalk.Browser._open()&quot;&gt;Class browser&lt;/button&gt;</p>
<p>&lt;div id=&quot;counters&quot;&gt;&lt;/div&gt;</p>
<p>&lt;script type=&quot;text/javascript&quot;&gt;<br />
  jQuery(document).ready(function() {'#counters'._asJQuery()._append_(smalltalk.Counter._new())});<br />
&lt;/script&gt;<br />
&lt;%= yield %&gt;</p>
<p>&lt;/body&gt;<br />
&lt;/html&gt;<br />
[/sourcecode]</p>
<p>Here, we included a button to open the code browser, and added a Counter in a div. Oh, I forgot to tell you: Jtalk works seamlessly with JQuery :)<br />
Now, go check it out, and you will seee the counter and be able to increase and decrease the value displayed (yes, that's a counter).</p>
<h2>Editing the code</h2>
<p>Click on the "Class browser" button to start the IDE. Select the "Examples" category, the "Counter" class, the "actions" method category, and the "increase method". You will see in the text box below the source code of the increase method:</p>
<p>[sourcecode language="smalltalk"]<br />
increase<br />
    count := count + 1.<br />
    header contents: [:html | html with: count asString]<br />
[/sourcecode]</p>
<p>Edit that method to increase by steps of 2 instead of 1, and hit "Save". Now, the counter on your page will increase by steps of 2.<br />
Unfortunately, on the next page refresh, you will lose these changes. That's why the "Commit category" button is there.<br />
It will take the updated files (here, Examples.st, Examples.js and Examples.deploy.js) and make a PUT request to their original URL.</p>
<p>A PUT, you said? Well, I can work something out with a PUT.</p>
<h2>Saving the code</h2>
<p>Let's create a new controller, called Uploader:</p>
<p>[sourcecode language="bash"]<br />
rails generate controller uploader jtalk<br />
[/sourcecode]</p>
<p>And edit config/routes.rb as follows:</p>
<p>[sourcecode language="ruby"]<br />
Jtalkonrails::Application.routes.draw do<br />
  root :to =&gt; &quot;home#index&quot;<br />
  if Rails.env == 'development'<br />
    put 'st/:id' =&gt; 'uploader#jtalk'<br />
    put 'js/:id' =&gt; 'uploader#jtalk'<br />
    put 'js/:id.:deploy' =&gt; 'uploader#jtalk'<br />
  end<br />
end<br />
[/sourcecode]</p>
<p>Now the PUT requests are redirected to our controller, but only in the development environment. You do not want to make your JS editable from the browser in a production app. DO NOT WANT!</p>
<p>The only thing left is the controller itself:</p>
<p>[sourcecode language="ruby"]<br />
class UploaderController &lt; ApplicationController</p>
<p>  def jtalk<br />
    path = Rails.root.join('public')<br />
    if(params[:format] == &quot;js&quot;)<br />
      path = path.join(&quot;js&quot;)<br />
    elsif(params[:format] == &quot;st&quot;)<br />
      path = path.join(&quot;st&quot;)<br />
    end</p>
<p>    if(params[:deploy])<br />
      path = path.join(params[:id]+&quot;.deploy.&quot;+params[:format])<br />
    else<br />
      path = path.join(params[:id]+&quot;.&quot;+params[:format])<br />
    end</p>
<p>    File.open(path, &quot;w&quot;) do |f|<br />
      f.write(request.body.read())<br />
    end</p>
<p>    head 200<br />
  end</p>
<p>end<br />
[/sourcecode]</p>
<p>Here, we build the file path from the parameters. I use <em>request.body.read()</em> to get the file content because Rails seems to truncate the beginning of the file.</p>
<h2>Profit</h2>
<p>Now, go back to the web page, click on "Commit category", and refresh the page. Your changes were saved! You can enjoy editing your frontend directly from the webpage itself, in the code browser, and more importantly, write your whole frontend in Smalltalk! It's still missing the workflow "edit-try-debug-edit-continue", but it already feels just like a "normal" Smalltalk environment. <strong>It feels like home</strong> :)</p>
<h3>Post Scriptum</h3>
<p>If you want to add a new category, it's easy: create a file <em>Mycategory.js</em> and put it in <em>public/js</em>, with this content:</p>
<p>[sourcecode language="javascript"]<br />
smalltalk.addClass('Myclass', smalltalk.Object, [], 'Mycategory');</p>
<p>[/sourcecode]</p>
<p>and change your initialization from <em>loadJtalk()</em> to <em>loadJtalk(new Array("Mycategory.js")).</em> The new category will now appear in the code browser, and clicking on "Commit category" will create the deployment file and Smalltalk source file.</p>

    

    
      
      
      

      
    
  </article>
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/development/reinventing%20the%20wheel/2011/08/16/manage-your-libraries-with-symlinks-on-windows.html">
        Manage your libraries with symlinks on Windows
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">16 Aug 2011</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        <a href="/category/development.html">
          Development
        </a>
      
    
      &bull;

      
      
      

      
        Reinventing the wheel
      
    
  </span>
</div>

    
      <p>My Windows development environment is a bit complex. I work on multiple projects, at multiple versions, with different compiler environments, and with dependencies on different libraries and versions of these libraries.</p>
<p>Now, how do I specify where the compiler must search the libraries, and which version to use? Most of the time, I will add it directly in the project configuration. Easy at first, but quickly,I find myself writing by hand the path to each library (and header) in each project and each configuration of this project. And then, writing by hand the different names of the libraries (mylibrary.lib, mylibraryd.lib, mylibrary-static.lib, mylibrary-MTD.lib, etc).</p>
<p>And when I want to update to a new version of the library? If I'm lucky, I just have to change the library and header paths (in every project using the library). If not, I also have to change the name, because of the library developer's convention.</p>
<p>The first solution to these problems was to use a batch file to launch Visual Studio and MSYS, and set some environment variables in this file. I quickly ended up with one big file containing two environment variables (include path and lib path) per library, possibly more if there were some big changes in the library names. My Visual Studio configuration was cluttered with $(MYLIBRARY_LIBPATH), $(MYLIBRARY_INCLUDEPATH), $(MYLIBRARY_NAME). It is unreadable, and again, impossible to maintain.</p>
<p>My solution comes from the Unix world, where you have a correct organization for your development files:</p>
<ul>
<li>one folder containing the subfolders include, bin and lib</li>
<li>library names including version, and a symlink (without the version number) to the latest version of the lib</li>
</ul>
<p>Can I do that on Windows? YES \o/</p>
<p><strong>Here is the trick</strong>: normal links on Windows won't work, but the <em>mklink </em>tool can create symlinks. And Visual Studio will recognize those as files and folders while looking for libraries.</p>
<p>Now, how would I organize my development environment? I chose to use (and abuse) symlinks, to create include, lib and bin folders for each project and configuration, and use generic names for the libraries.</p>
<ul>
<li>I create a folder containing include, lib and bin</li>
<li>in the  include/ folder, I put symlinks to the header file or the subfolder for each library I will use in that project</li>
<li>in the lib directory, I create symlinks to the library version I want, one symlink per static/dynamic, MT/MD, Debug/Release version. But I could create one lib folder per static/dynamic, etc. A bit complex, but feasible (most of the time, I use only debug and release version, so it's still manageable).</li>
</ul>
<p>With this setup, I only set the INCLUDE and LIB environment variables, and I use directly the library names I need.</p>
<p>Here is an example script I use to create different library folders for x86 and x64 libs:</p>
<p>[sourcecode language="text"]<br />
echo &quot;Building include and library directories for Windows %PLATFORM%&quot;</p>
<p>@mkdir %PLATFORM%<br />
@mkdir %PLATFORM%\include<br />
@mkdir %PLATFORM%\lib</p>
<p>@mklink /D %PLATFORM%\include\boost %BOOST%\boost<br />
@for %%i in (%BOOST%\lib\*.lib) do (mklink %PLATFORM%\lib\%%~ni.lib %%~fi)</p>
<p>@mklink /D %PLATFORM%\include\cpptest %CPPTEST%\include\cpptest<br />
@for %%i in (%CPPTEST%\lib\*.lib) do (mklink %PLATFORM%\lib\%%~ni.lib %%~fi)</p>
<p>[/sourcecode]</p>
<p>I set up the BOOST and CPPTEST environment variables in another file. Then, I launch Visual Studio from another script which includes it.</p>
<p>There may be better ways, and that system will evolve in the future, but I'm pretty comfortable with it right now :)</p>
<p>Depending on my needs, I may grab from the bottom of my disk the package manager I wrote back in school, and make a big solution to download, build and link libs and personal projects. But later, I have some procrastination planned right now.</p>

    

    
      
      
      

      
    
  </article>
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/development/ruby/security/2011/06/28/rails-and-oauth-plugin-part-2-the-consumer.html">
        Rails and oauth-plugin part 2: the consumer
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">28 Jun 2011</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        <a href="/category/development.html">
          Development
        </a>
      
    
      &bull;

      
      
      

      
        Ruby
      
    
      &bull;

      
      
      

      
        <a href="/category/security.html">
          Security
        </a>
      
    
  </span>
</div>

    
      <p>In the previous post, I showed how you could build a provider with oauth-plugin and Rails. Now, I will demonstrate how to build a consumer (it's a lot easier).</p>
<p>I will assume that your provider is already running on localhost:3000. The consumer will run on localhost:4000 (run it with "rails server -p 4000").</p>
<h2>Here we go!</h2>
<p>[sourcecode language="bash"]<br />
rails new consumer<br />
cd consumer<br />
[/sourcecode]</p>
<p>Put this in your Gemfile:</p>
<p>[sourcecode language="ruby"]<br />
source 'http://rubygems.org'<br />
gem 'rails', '3.0.7'<br />
gem 'sqlite3'<br />
gem 'devise'<br />
gem &quot;oauth-plugin&quot;, &quot;&gt;= 0.4.0.pre1&quot;<br />
[/sourcecode]</p>
<p>And run these commands:</p>
<p>[sourcecode language="bash"]<br />
bundle install<br />
rails generate devise:install<br />
rails generate devise User<br />
rake db:migrate<br />
rails generate controller welcome index<br />
rm public/index.html<br />
[/sourcecode]</p>
<p>And here is your routes.rb:</p>
<p>[sourcecode language="ruby"]<br />
Provider::Application.routes.draw do<br />
devise_for :users<br />
root :to =&gt; &quot;welcome#index&quot;<br />
end<br />
[/sourcecode]</p>
<h2>Create the consumer</h2>
<p>[sourcecode language="bash"]<br />
rails generate oauth_consumer user<br />
rake db:migrate<br />
[/sourcecode]</p>
<p>in app/controllers/oauth_consumers_controller.rb, replace:</p>
<p>[sourcecode language="ruby"]<br />
before_filter :login_required, :only=&gt;:index<br />
[/sourcecode]</p>
<p>by</p>
<p>[sourcecode language="ruby"]<br />
before_filter :authenticate_user!, :only=&gt;:index<br />
[/sourcecode]</p>
<p>Uncomment the methods for devise (go_back, logged_in? currentuser=, deny_access!) in app/controllers/oauth_consumers_controller.rb.</p>
<p>Add to app/models/user.rb:</p>
<p>[sourcecode language="ruby"]<br />
 has_one  :test, :class_name=&gt;&quot;TestToken&quot;, :dependent=&gt;:destroy<br />
[/sourcecode]</p>
<p>Now go to http://localhost:3000/oauth_clients/ to register your first application with these parameters:</p>
<blockquote><p>Name:                 Test consumer<br />
Main Application URL: http://localhost:4000/<br />
Callback URL:         http://localhost:4000/oauth_consumers/test/callback</p></blockquote>
<p>You're redirected to http://localhost:3000/oauth_clients/1. It shows:</p>
<blockquote><p>Consumer Key:      CRcIJ15MwSqlDTxsH8MpO3En4wjaOxkqeofLioH4</p>
<p>Consumer Secret:   C7uci8xkyMShCf4SNXWPclKbBo3ml1Zf2W2XWu4W</p>
<p>Request Token URL: http://localhost:3000/oauth/request_token</p>
<p>Access Token URL:  http://localhost:3000/oauth/access_token</p>
<p>Authorize URL:     http://localhost:3000/oauth/authorize</p></blockquote>
<p>Now, you need to put the key and secret in config/initializers/oauth_consumers.rb:</p>
<p>[sourcecode language="ruby"]<br />
 OAUTH_CREDENTIALS={<br />
:test =&gt;{<br />
:key =&gt; &quot;CRcIJ15MwSqlDTxsH8MpO3En4wjaOxkqeofLioH4&quot;,<br />
     :secret =&gt; &quot;C7uci8xkyMShCf4SNXWPclKbBo3ml1Zf2W2XWu4W&quot;,<br />
     :expose =&gt; true<br />
   }<br />
 }<br />
[/sourcecode]</p>
<p>Create app/models/test_token.rb. This model will store the token for your provider. If you want to provide helpful methods, take inspiration from lib/oauth/models/consumers/services/.</p>
<p>[sourcecode language="ruby"]<br />
class TestToken &lt; ConsumerToken<br />
TEST_SETTINGS={<br />
:site =&gt; &quot;http://localhost:3000&quot;,<br />
:request_token_path =&gt; &quot;/oauth/request_token&quot;,<br />
:access_token_path =&gt; &quot;/oauth/access_token&quot;,<br />
:authorize_path =&gt; &quot;/oauth/authorize&quot;<br />
}</p>
<p>def self.consumer(options={})<br />
@consumer ||= OAuth::Consumer.new(credentials[:key], credentials[:secret], TEST_SETTINGS.merge(options))<br />
end</p>
<p>end<br />
[/sourcecode]</p>
<p>You should now be able to use the URLs "/oauth_consumers/test/client/", "/oauth_consumers/test/callback", "/oauth_consumers/test/callback2"," /oauth_consumers/test/edit",<br />
and "/oauth_consumers/test".</p>
<p>Modify the welcome controller t get the provider data:</p>
<p>[sourcecode language="ruby"]<br />
 class WelcomeController &lt; ApplicationController<br />
 def index<br />
 # cf http://oauth.rubyforge.org/rdoc/classes/OAuth/AccessToken.html<br />
 @consumer_tokens=TestToken.all :conditions=&gt;{:user_id=&gt;current_user.id}<br />
 @token = @consumer_tokens.first.client<br />
 logger.info &quot;private data: &quot;+@token.get(&quot;/data/index&quot;).body<br />
 end</p>
<p>end<br />
[/sourcecode]</p>
<p>To connect a user to an external service link or redirect them to:</p>
<p>/oauth_consumers/[SERVICE_NAME]</p>
<p>Where SERVICE_NAME is the name you set in the OAUTH_CREDENTIALS hash. This will request the request token and redirect the user to the services authorization screen. When the user accepts the get redirected back to:</p>
<p>/oauth_consumers/[SERVICE_NAME]/callback</p>
<h2>That's it</h2>
<p>This tutorial is really short, and could be explained a bit more, but I'll leave that for another post. You have enough to start tinkering with OAuth. Have fun!</p>

    

    
      
      
      

      
    
  </article>
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/development/ruby/security/2011/06/02/rails-and-oauth-plugin-part-1-the-provider.html">
        Rails and oauth-plugin part 1: the provider
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">02 Jun 2011</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        <a href="/category/development.html">
          Development
        </a>
      
    
      &bull;

      
      
      

      
        Ruby
      
    
      &bull;

      
      
      

      
        <a href="/category/security.html">
          Security
        </a>
      
    
  </span>
</div>

    
      <p>These days, I have been playing a lot with Oauth and its RoR implementation, <a title="Oauth-plugin" href="http://code.google.com/p/oauth-plugin/">oauth-plugin</a>. Its documentation is a bit short, so here is a tutorial to show how to use it, both in provider and consumer mode. And we will even make them communicate with each other.</p>
<p>We will now build an Oauth provider using oauth-plugin for authorization and Devise for authentication. And we will add a controller protected by Oauth.</p>
<h2>Starting up</h2>
<p>A few instructions to create the application. You won't need an explanation for this:</p>
<p>[sourcecode language="bash"]<br />
rails new provider<br />
cd provider<br />
[/sourcecode]</p>
<p>Put this in your Gemfile:</p>
<p>[sourcecode language="ruby"]<br />
source 'http://rubygems.org'<br />
gem 'rails', '3.0.7'<br />
gem 'sqlite3'<br />
gem 'devise'<br />
gem &quot;oauth-plugin&quot;, &quot;&gt;= 0.4.0.pre1&quot;<br />
[/sourcecode]</p>
<p>And a few more commands:</p>
<p>[sourcecode language="bash"]<br />
bundle install<br />
rails generate devise:install<br />
rails generate devise User<br />
rake db:migrate<br />
rails generate controller welcome index<br />
rm public/index.html<br />
[/sourcecode]</p>
<p>And don't forget 'root :to =&gt; "welcome#index"' in config/routes.rb.</p>
<h2>Create the provider</h2>
<p>[sourcecode language="bash"]<br />
rails generate oauth_provider oauth</p>
<p>rake db:migrate<br />
[/sourcecode]</p>
<p>You could put something else than "oauth" as parameter, but for the moment, the generator has some bugs (it always generate the class OauthController, but with a different name). I'll check more recent versions of the code.</p>
<p>Now, modify config/application.rb and add:</p>
<p>[sourcecode language="ruby"]<br />
require 'oauth/rack/oauth_filter'<br />
config.middleware.use OAuth::Rack::OAuthFilter<br />
[/sourcecode]</p>
<p>Put in app/models/user.rb:</p>
<p>[sourcecode language="ruby"]</p>
<p>has_many :client_applications</p>
<p>has_many :tokens, :class_name=&gt;&quot;OauthToken&quot;,:order=&gt;&quot;authorized_at desc&quot;,:include=&gt;[:client_application]</p>
<p>[/sourcecode]</p>
<p>Put in app/controllers/oauth_controller.rb:</p>
<p>[sourcecode language="ruby"]</p>
<p>alias :logged_in? :user_signed_in?</p>
<p>alias :login_required :authenticate_user!</p>
<p>[/sourcecode]</p>
<p>and uncomment authenticate_user.</p>
<p>Put in app/controllers/oauth_clients_controller.rb:</p>
<p>[sourcecode language="ruby"]<br />
alias :login_required :authenticate_user!<br />
[/sourcecode]</p>
<h2>And now some data</h2>
<p>Create a new controller:</p>
<p>[sourcecode language="bash"]</p>
<p>rails generate controller data index</p>
<p>[/sourcecode]</p>
<p>And now, edit your controller:</p>
<p>[sourcecode language="ruby"]<br />
class DataController &lt; ApplicationController<br />
  before_filter :oauth_required</p>
<p>  def index<br />
    @data = { &quot;coincoin&quot; =&gt; &quot;o&lt; o&lt;&quot; }</p>
<p>    respond_to do |format|<br />
      format.json { render :json =&gt; @data }<br />
    end</p>
<p>  end<br />
end<br />
[/sourcecode]</p>
<h3>UPDATE</h3>
<p>I discovered a few bugs in this tutorial, so here are the fixes.</p>
<p>oauth-plugin needs the function current_user=, so add this to your ApplicationController:</p>
<p>[sourcecode language="ruby"]<br />
def current_user=(user)<br />
  current_user = user<br />
end<br />
[/sourcecode]</p>
<p>Next, to handle revocation, you need to add this to config/routes.rb:</p>
<p>[sourcecode language="ruby"]<br />
post 'oauth/revoke'<br />
[/sourcecode]</p>
<p>And at last, you need to fix the rack filter. The current code doesn't verify the token validity, and lets revoked tokens access your data.<br />
You have to modify lib/oauth/rack/oauth_filter.rb in the oauth-plugin gem folder.<br />
Replace the line 46:</p>
<p>[sourcecode language="ruby"]<br />
oauth_token = client_application.tokens.first(:conditions=&gt;{:token =&gt; request_proxy.token})<br />
[/sourcecode]</p>
<p>by</p>
<p>[sourcecode language="ruby"]<br />
oauth_token = ClientApplication.find_token(request_proxy.token)<br />
[/sourcecode]</p>
<h2>And that's it!</h2>
<p>You now have a working provider. OauthController handles all the communication with the consumers. OauthClientsController manages the registration of new consumers. They both have customizable views: oauth for the authorization part (for users) and oauth clients for the consumers. And you just need the oauth_required filter to manage access to your data.</p>
<p>And now, you can go to /users/sign_up, then /users/sign_in, then /oauth_clients to register a new client application. You just need to give a name for your application, your URL, and a callback URL.</p>
<p>In the next post, we will build a consumer, and this consumer will access the provider's data.</p>

    

    
      
      
      

      
    
  </article>
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/development/reinventing%20the%20wheel/security/web/2011/04/01/yet-another-authentication-scheme.html">
        Yet another authentication scheme
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">01 Apr 2011</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        <a href="/category/development.html">
          Development
        </a>
      
    
      &bull;

      
      
      

      
        Reinventing the wheel
      
    
      &bull;

      
      
      

      
        <a href="/category/security.html">
          Security
        </a>
      
    
      &bull;

      
      
      

      
        Web
      
    
  </span>
</div>

    
      <p>Recently, I was asked to design a new authentication protocol for a web service. I know that I shouldn't do reinvent the wheel, so I immediatly proposed OAUTH.  It turns out that it can't be used in this situation. Here are the constraints:</p>
<p>-calls to the webservice must be authenticated: I can keep the tokens and signature from OAUTH here. The problem is: how do I get that token?</p>
<p>-calls are made from devices or applications without access to a webbrowser (embedded devices, phones, etc.). The redirection dance of OAUTH is not acceptable here</p>
<p>-communications are done over an untrusted network, without SSL.</p>
<p>-I can't use application keys and secrets to encrypt and sign the authentication process: clients include open source software and smartphone applications. You can't hide a secret key in these.</p>
<p>-the protocol has to be simple to implement, on a lot of languages</p>
<p>-the server must not store the password in cleartext (I shouldn't have to precise this...), the client must not store the password</p>
<p>Summing it up: no preshared keys, no browser, no SSL, untrusted networks, no passwords stored, and an OAUTH-like environment once the client is authenticated (tokens, authorizations, revoking, etc)</p>
<p>Apparently, I should just give up. But I like to play, so I'll try!</p>
<p>First, I must say that I am not an expert in security nor cryptography. But I'm really enthusiastic about these subjects, and my day job is at a company providing strong authentication solutions (no, this protocol is not related to my day job). So, I know a bit about the subject, and I know that I should ask for reviews, hence this post.</p>
<h2>Rough ideas</h2>
<p>We need a safe communication over an untrusted network. TLS immediatly comes to mind, but the targeted applications might not have access to a TLS implementation. I'd like to use SRP, but I don't think I'm able to implement it correctly (and it has to be SIMPLE). Using Diffie-Hellman to establish a shared key is another idea, but it is not safe against MITM.</p>
<p>Here's my idea: we don't need to generate a shared secret, we already have it. It's the password!</p>
<p>But how can I use the password if the server doesn't store it in cleartext?</p>
<h2>The trick: key derivation functions</h2>
<p>Decveoplers are finally understanding that they should not use MD5 nor SHA1 to store their passwords, even with a salt, because computing power is so cheap these days that anyone could crack easily a lot of passwords.</p>
<p>It is now recommended to use other functrions tro store passwords. The key derivation functions are a class of functions that create a key from a password. Basically, they do it by interating a lot of times. That makes them very slow, which is an interesting property if you want to stpre passwords: it is too expensive to "crack" the password. PBKDF2, bcrypt and scrypt are well known  key derivation functions. They're simple to use and available in a lot of languages.</p>
<p>With these functions, I can safely store the passwords, and generate a key shared with the client.</p>
<p>In short: if I store kdf(password, N) with N the number of iterations, I can send any M &gt; N to the client and ask him to compute the key, without compromising what I store.</p>
<h2>Designing the protocol</h2>
<p>Now that we have a way to use a shared key, we can look at what will go over the wire to establish it. If I use directly kdf(pass, M), anybody getting access to the client storage will be able to obtain the key for any L &gt; M. So, the key establishment has to use a nonce. That way, the client will only use the password once and forget it, and store the derivated key.</p>
<p>I would rather use a truly random key that has no relation with the password. It could be given to the client, encrypted with the derivated key. The derivated key could then be thrown away. But I still do not know if it is really necesary.</p>
<p>The server still needs to authenticate the client. The client will make a second call to the web service, signing it with HMAC and the key.</p>
<p>That's it! It is really simple, so if there are flaws I did not see, you will surely catch them.</p>
<h2>TL; DR</h2>
<p>The protocol is based on key derivation functions, like PBKDF or bcrypt.</p>
<ul>
<li>The server stores login and H = kdf(pass, N), with N integer</li>
<li>The client wants to authenticate and makes a call to the server with the login as argument</li>
<li>The server replies with M &gt; N and i nonce</li>
<li>The client calculates k1 = kdf(kdf(pass, M)+i, 1)</li>
<li>The server calculates k2 = kdf(kdf(H, M-N)+i, 1)</li>
<li>The client calls the server with args "user=login&amp;sign=".HMAC("user=login", k2)</li>
<li>If k1=k2. The signature matches and the client is authenticated.</li>
</ul>

    

    
      
      
      

      
    
  </article>
  

  
<div class="pagination">
  <a class="pagination-item older"
     href="/page10">
    Older
  </a>
</div>


</div>
    </main>

    <!-- Optional footer content -->

  </body>
</html>
